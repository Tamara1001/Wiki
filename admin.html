<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Admin User Management - RPG Game Wiki">
    <title>Admin - User Management | RPG Game Wiki</title>
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Main Content -->
        <div class="main-content" style="margin-left: 0;">
            <header class="top-bar">
                <a href="index.html" class="btn-back" style="margin-right: 20px;">‚Üê Back to Wiki</a>
                <h2 style="flex-grow: 1; margin: 0;">Admin - User Management</h2>
                <div class="user-controls">
                    <span id="userDisplay" class="user-display">Admin</span>
                </div>
            </header>

            <main style="padding: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <!-- SECTION 1: WIKI SETTINGS -->
                <div class="admin-panel-section">
                    <h2
                        style="border-bottom: 2px solid var(--accent-primary); padding-bottom: 10px; margin-bottom: 20px;">
                        Wiki Settings</h2>

                    <section class="admin-section">
                        <h3>General Configuration</h3>

                        <!-- Rich Text Toolbar -->
                        <div class="rich-text-toolbar" id="adminToolbar"
                            style="margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; padding: 8px; background: var(--bg-dark); border-radius: 6px;">
                            <button type="button" data-cmd="bold" title="Bold (Ctrl+B)"
                                style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;"><b>B</b></button>
                            <button type="button" data-cmd="italic" title="Italic (Ctrl+I)"
                                style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;"><i>I</i></button>
                            <button type="button" data-cmd="underline" title="Underline (Ctrl+U)"
                                style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;"><u>U</u></button>
                            <button type="button" data-cmd="strikeThrough" title="Strikethrough"
                                style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;"><s>S</s></button>
                            <span style="width: 1px; background: var(--border-color); margin: 0 5px;"></span>
                            <select id="adminColorSelect" title="Text Color"
                                style="padding: 6px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;">
                                <option value="">Color</option>
                                <option value="#ffffff">White</option>
                                <option value="#888888">Gray</option>
                                <option value="#f44336">Red</option>
                                <option value="#ff9800">Orange</option>
                                <option value="#ffeb3b">Yellow</option>
                                <option value="#4CAF50">Green</option>
                                <option value="#2196F3">Blue</option>
                                <option value="#9c27b0">Violet</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="color" id="adminCustomColor"
                                style="width: 0; height: 0; opacity: 0; position: absolute;" title="Pick custom color">
                            <span style="width: 1px; background: var(--border-color); margin: 0 5px;"></span>
                            <button type="button" data-cmd="removeFormat" title="Clear Formatting"
                                style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>

                        <div class="form-group">
                            <label>Homepage Hero Title</label>
                            <div id="wiki-hero-title" contenteditable="true"
                                style="width: 100%; min-height: 40px; padding: 10px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 15px;">
                            </div>

                            <label>Homepage Hero Subtitle</label>
                            <div id="wiki-hero-subtitle" contenteditable="true"
                                style="width: 100%; min-height: 80px; padding: 10px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                            </div>
                        </div>

                        <!-- Background Image Section -->
                        <div class="form-group"
                            style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label>Background Image</label>
                            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">
                                This image will be displayed as the background on all wiki pages.
                            </p>

                            <div id="bg-image-preview"
                                style="margin-bottom: 15px; border-radius: 8px; overflow: hidden; max-width: 300px;">
                                <!-- Image preview will be inserted here -->
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <label class="btn-primary"
                                    style="cursor: pointer; display: inline-flex; align-items: center; padding: 10px 20px;">
                                    üì∑ Upload Image
                                    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">
                                </label>
                                <button id="deleteBgImageBtn" class="btn-back"
                                    style="padding: 10px 20px; width: auto; background: #ff5252;">
                                    üóëÔ∏è Remove Background
                                </button>
                            </div>
                        </div>

                        <!-- Accent Color Section -->
                        <div class="form-group"
                            style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label>Accent Color</label>
                            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">
                                This color is used for highlights, links, and interactive elements. It will not affect
                                manually formatted text.
                            </p>

                            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <!-- Current color preview -->
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div id="accentColorPreview"
                                        style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--accent-primary);">
                                    </div>
                                    <span id="accentColorValue"
                                        style="font-family: monospace; color: var(--text-secondary);">#00d4aa</span>
                                </div>

                                <!-- Preset colors -->
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button type="button" class="accent-preset" data-color="#00d4aa"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #00d4aa; cursor: pointer;"
                                        title="Teal (Default)"></button>
                                    <button type="button" class="accent-preset" data-color="#2196F3"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #2196F3; cursor: pointer;"
                                        title="Blue"></button>
                                    <button type="button" class="accent-preset" data-color="#9c27b0"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #9c27b0; cursor: pointer;"
                                        title="Purple"></button>
                                    <button type="button" class="accent-preset" data-color="#e91e63"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #e91e63; cursor: pointer;"
                                        title="Pink"></button>
                                    <button type="button" class="accent-preset" data-color="#ff9800"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #ff9800; cursor: pointer;"
                                        title="Orange"></button>
                                    <button type="button" class="accent-preset" data-color="#4CAF50"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #4CAF50; cursor: pointer;"
                                        title="Green"></button>
                                    <button type="button" class="accent-preset" data-color="#f44336"
                                        style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #f44336; cursor: pointer;"
                                        title="Red"></button>
                                </div>

                                <!-- Custom color picker -->
                                <label
                                    style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px;">
                                    üé® Custom
                                    <input type="color" id="accentColorPicker"
                                        style="width: 30px; height: 30px; border: none; cursor: pointer;">
                                </label>
                            </div>
                        </div>

                        <!-- Default Font Size Section -->
                        <div class="form-group"
                            style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <label>Default Description Font Size</label>
                            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">
                                Set the default font size for item descriptions across the wiki.
                            </p>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <select id="defaultFontSize"
                                    style="padding: 10px 15px; background: var(--bg-dark); color: white; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em;">
                                    <option value="10">10px</option>
                                    <option value="12">12px</option>
                                    <option value="14">14px</option>
                                    <option value="16" selected>16px (Default)</option>
                                    <option value="18">18px</option>
                                    <option value="20">20px</option>
                                    <option value="24">24px</option>
                                </select>
                                <span id="fontSizePreview"
                                    style="font-size: 16px; color: var(--text-secondary);">Preview Text</span>
                            </div>
                        </div>

                        <button id="saveSettingsBtn" class="btn-primary" style="margin-top: 15px;">Save
                            Settings</button>
                    </section>
                </div>

                <!-- SECTION 2: USER MANAGEMENT -->
                <div class="admin-panel-section">
                    <h2
                        style="border-bottom: 2px solid var(--accent-primary); padding-bottom: 10px; margin-bottom: 20px;">
                        User Management</h2>

                    <!-- Add User Form -->
                    <section class="admin-section" style="margin-bottom: 30px;">
                        <h3>Add New User</h3>
                        <div class="form-group" style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label for="new-username"
                                        style="display: block; margin-bottom: 5px; font-size: 0.9em;">Username</label>
                                    <input type="text" id="new-username" placeholder="Enter username"
                                        style="width: 100%;">
                                </div>
                                <div style="flex: 1;">
                                    <label for="new-password"
                                        style="display: block; margin-bottom: 5px; font-size: 0.9em;">Password</label>
                                    <input type="password" id="new-password" placeholder="Enter password"
                                        style="width: 100%;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label for="new-role"
                                        style="display: block; margin-bottom: 5px; font-size: 0.9em;">Role</label>
                                    <select id="new-role"
                                        style="width: 100%; padding: 10px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color);">
                                        <option value="custom">Custom</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button id="addUserBtn" class="btn-primary"
                                    style="width: auto; padding: 10px 20px; white-space: nowrap;">+ Add User</button>
                            </div>
                        </div>
                    </section>

                    <!-- User List -->
                    <section class="admin-section">
                        <h3>User List</h3>
                        <div id="userListContainer">
                            <!-- Populated by JS -->
                        </div>
                    </section>
                </div>
            </main>

            <footer>
                <p>&copy; 2025 RPG Game Wiki. Admin Panel.</p>
            </footer>
        </div>
    </div>

    <script src="assets/data.js"></script>
    <script src="assets/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is admin
            const session = sessionStorage.getItem('wikiUser');
            if (!session) {
                alert('Access Denied. Please login as Admin.');
                window.location.href = 'index.html';
                return;
            }
            const user = JSON.parse(session);
            if (user.role !== 'admin') {
                alert('Access Denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userDisplay').textContent = user.username + ' (Admin)';

            renderUserList();

            // Initialize Wiki Settings once data is ready
            // script.js loads data asynchronously/on-load, so we must wait
            const waitForData = setInterval(() => {
                if (localWikiData) {
                    clearInterval(waitForData);
                    console.log('Admin: Wiki Data loaded, initializing settings...');
                    initWikiSettings();
                }
            }, 50);

            document.getElementById('addUserBtn').onclick = addNewUser;
            document.getElementById('saveSettingsBtn').onclick = saveWikiSettings;
        });

        function initWikiSettings() {
            // Load current settings from script.js global data (localWikiData)
            // Note: Since data is loaded via data.js and script.js, we should access it if available
            // But this page imports script.js so `localWikiData` should be available globally

            // Wait slightly ensuring script.js init ran? 
            // script.js runs on load. 
            // We can check if localWikiData is populated.

            if (typeof localWikiData !== 'undefined') {
                document.getElementById('wiki-hero-title').innerHTML = localWikiData.heroTitle || 'Welcome to the Wiki';
                document.getElementById('wiki-hero-subtitle').innerHTML = localWikiData.heroSubtitle || '';

                // Load background image preview
                updateBgImagePreview();

                // Load accent color preview
                updateAccentColorPreview(localWikiData.accentColor || '#00d4aa');

                // Load default font size
                const fontSizeSelect = document.getElementById('defaultFontSize');
                const savedFontSize = localWikiData.defaultFontSize || '16';
                if (fontSizeSelect) {
                    fontSizeSelect.value = savedFontSize;
                    updateFontSizePreview(savedFontSize);
                }
            }

            // Initialize toolbar
            initAdminToolbar();

            // Initialize background image handlers
            initBgImageHandlers();

            // Initialize accent color handlers
            initAccentColorHandlers();

            // Initialize font size handlers
            initFontSizeHandlers();
        }

        // Track selected accent color
        let selectedAccentColor = '#00d4aa';

        function updateAccentColorPreview(color) {
            selectedAccentColor = color;
            const preview = document.getElementById('accentColorPreview');
            const value = document.getElementById('accentColorValue');
            const picker = document.getElementById('accentColorPicker');

            if (preview) preview.style.background = color;
            if (value) value.textContent = color;
            if (picker) picker.value = color;

            // Highlight the matching preset
            document.querySelectorAll('.accent-preset').forEach(btn => {
                if (btn.dataset.color.toLowerCase() === color.toLowerCase()) {
                    btn.style.borderColor = 'white';
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.borderColor = 'transparent';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        function initAccentColorHandlers() {
            // Preset color buttons
            document.querySelectorAll('.accent-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    updateAccentColorPreview(btn.dataset.color);
                });
            });

            // Custom color picker
            const picker = document.getElementById('accentColorPicker');
            picker.addEventListener('input', (e) => {
                updateAccentColorPreview(e.target.value);
            });
        }

        function updateFontSizePreview(size) {
            const preview = document.getElementById('fontSizePreview');
            if (preview) {
                preview.style.fontSize = size + 'px';
                preview.textContent = 'Preview Text (' + size + 'px)';
            }
        }

        function initFontSizeHandlers() {
            const fontSizeSelect = document.getElementById('defaultFontSize');
            if (fontSizeSelect) {
                fontSizeSelect.addEventListener('change', (e) => {
                    updateFontSizePreview(e.target.value);
                });
            }
        }

        function updateBgImagePreview() {
            const previewContainer = document.getElementById('bg-image-preview');
            const deleteBtn = document.getElementById('deleteBgImageBtn');

            if (localWikiData.backgroundImage) {
                previewContainer.innerHTML = `
                    <img src="${localWikiData.backgroundImage}" alt="Background Preview" 
                         style="width: 100%; height: auto; display: block; border: 2px solid var(--border-color); border-radius: 8px;">
                `;
                deleteBtn.style.display = 'inline-flex';
            } else {
                previewContainer.innerHTML = `
                    <div style="padding: 30px; background: var(--bg-dark); border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; color: var(--text-secondary);">
                        No background image set
                    </div>
                `;
                deleteBtn.style.display = 'none';
            }
        }

        function initBgImageHandlers() {
            const bgInput = document.getElementById('bg-image-input');
            const deleteBtn = document.getElementById('deleteBgImageBtn');

            bgInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    // Resize image to reasonable size for storage
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        const maxWidth = 1920;
                        const maxHeight = 1080;
                        let width = tempImg.width;
                        let height = tempImg.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(tempImg, 0, 0, width, height);

                        // Store as JPEG for smaller size
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        localWikiData.backgroundImage = base64;
                        updateBgImagePreview();
                    };
                    tempImg.src = event.target.result;
                };
                reader.readAsDataURL(file);
                bgInput.value = ''; // Reset so same file can be selected again
            });

            deleteBtn.addEventListener('click', () => {
                if (confirm('Remove background image?')) {
                    localWikiData.backgroundImage = null;
                    updateBgImagePreview();
                }
            });
        }

        function initAdminToolbar() {
            // Toolbar command buttons
            document.querySelectorAll('#adminToolbar button[data-cmd]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const cmd = btn.dataset.cmd;
                    document.execCommand(cmd, false, null);
                });
            });

            // Color picker
            const colorSelect = document.getElementById('adminColorSelect');
            const customColorPicker = document.getElementById('adminCustomColor');

            colorSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customColorPicker.click();
                    e.target.value = '';
                } else if (e.target.value) {
                    document.execCommand('foreColor', false, e.target.value);
                    e.target.value = '';
                }
            });

            customColorPicker.addEventListener('input', (e) => {
                document.execCommand('foreColor', false, e.target.value);
            });
        }

        function saveWikiSettings() {
            const newTitle = document.getElementById('wiki-hero-title').innerHTML;
            const newSubtitle = document.getElementById('wiki-hero-subtitle').innerHTML;
            const defaultFontSize = document.getElementById('defaultFontSize').value;

            if (typeof localWikiData !== 'undefined') {
                localWikiData.heroTitle = newTitle;
                localWikiData.heroSubtitle = newSubtitle;
                // backgroundImage is already set by upload handler
                // Save accent color
                localWikiData.accentColor = selectedAccentColor;
                // Save default font size
                localWikiData.defaultFontSize = defaultFontSize;
                persistData(); // Defined in script.js
                // Apply the accent color immediately
                if (typeof applyAccentColor === 'function') {
                    applyAccentColor();
                }
                // Apply the font size immediately
                if (typeof applyDefaultFontSize === 'function') {
                    applyDefaultFontSize();
                }
                alert('Settings saved successfully!');
            } else {
                alert('Error: Wiki data not loaded.');
            }
        }

        function renderUserList() {
            const container = document.getElementById('userListContainer');
            const localUsers = getLocalUsers();

            if (localUsers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No users found.</p>';
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-card); border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 12px; text-align: left;">Username</th>
                            <th style="padding: 12px; text-align: left;">Role</th>
                            <th style="padding: 12px; text-align: left;">Characters</th>
                            <th style="padding: 12px; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            localUsers.forEach((u, index) => {
                const chars = u.characters || [];
                const charsDisplay = chars.length > 0
                    ? chars.map(c => `<span style="background: var(--accent-blue); padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-right: 4px;">${c}</span>`).join('')
                    : '<span style="color: var(--text-secondary); font-size: 0.8em;">No characters</span>';

                html += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;">${u.username}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${u.role === 'admin' ? '#ff5252' : 'var(--accent-blue)'}; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                                ${u.role}
                            </span>
                        </td>
                        <td style="padding: 12px;">${charsDisplay}</td>
                        <td style="padding: 12px; text-align: right;">
                            <button class="btn-back chars-user-btn" data-index="${index}" style="padding: 5px 10px; font-size: 0.8rem; width: auto; margin-right: 5px; background-color: #9c27b0;">Characters</button>
                            <button class="btn-back edit-user-btn" data-index="${index}" style="padding: 5px 10px; font-size: 0.8rem; width: auto; margin-right: 5px;">Edit</button>
                            <button class="btn-back delete-user-btn" data-index="${index}" data-confirm="idle" style="padding: 5px 10px; font-size: 0.8rem; width: auto; background-color: #ff5252; transition: all 0.2s;">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Attach Edit button listeners
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    editUserPrompt(parseInt(btn.dataset.index));
                });
            });

            // Attach Delete button listeners with 2-step verification
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const index = parseInt(btn.dataset.index);

                    if (btn.dataset.confirm === 'idle') {
                        // FIRST CLICK: ARM
                        btn.dataset.confirm = 'confirm';
                        btn.textContent = 'Confirm?';
                        btn.style.transform = 'scale(1.1)';
                        btn.style.backgroundColor = '#d32f2f';

                        // Auto-reset after 3 seconds
                        setTimeout(() => {
                            if (btn.dataset.confirm === 'confirm') {
                                btn.dataset.confirm = 'idle';
                                btn.textContent = 'Delete';
                                btn.style.transform = 'scale(1)';
                                btn.style.backgroundColor = '#ff5252';
                            }
                        }, 3000);
                    } else if (btn.dataset.confirm === 'confirm') {
                        // SECOND CLICK: EXECUTE
                        executeDeleteUser(index);
                    }
                });
            });

            // Attach Characters button listeners
            document.querySelectorAll('.chars-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openCharacterManager(parseInt(btn.dataset.index));
                });
            });
        }

        let currentCharUserIndex = null;

        function openCharacterManager(userIndex) {
            currentCharUserIndex = userIndex;
            const localUsers = getLocalUsers();
            const user = localUsers[userIndex];
            const chars = user.characters || [];

            // Create modal overlay
            let modal = document.getElementById('charManagerModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'charManagerModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                document.body.appendChild(modal);
            }

            let charListHtml = chars.length > 0
                ? chars.map((c, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-dark); margin-bottom: 5px; border-radius: 4px;">
                        <span>${c}</span>
                        <button class="remove-char-btn" data-char-index="${i}" style="background: #ff5252; border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                    </div>
                `).join('')
                : '<p style="color: var(--text-secondary);">No characters assigned.</p>';

            modal.innerHTML = `
                <div style="background: var(--bg-card); padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
                    <h3 style="margin-top: 0;">Manage Characters: ${user.username}</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label>Add Character</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="text" id="new-char-name" placeholder="Character name" style="flex: 1; padding: 10px; background: var(--bg-dark); color: white; border: 1px solid var(--border-color);">
                            <button id="add-char-btn" class="btn-primary" style="width: auto; padding: 10px 15px;">+ Add</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>Current Characters</label>
                        <div id="char-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                            ${charListHtml}
                        </div>
                    </div>
                    
                    <button id="close-char-modal" class="btn-back" style="width: 100%;">Close</button>
                </div>
            `;

            modal.style.display = 'flex';

            // Add char button
            document.getElementById('add-char-btn').addEventListener('click', () => {
                const charName = document.getElementById('new-char-name').value.trim();
                if (charName) {
                    addCharacterToUser(currentCharUserIndex, charName);
                    openCharacterManager(currentCharUserIndex); // Refresh modal
                }
            });

            // Remove char buttons
            document.querySelectorAll('.remove-char-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    removeCharacterFromUser(currentCharUserIndex, parseInt(btn.dataset.charIndex));
                    openCharacterManager(currentCharUserIndex); // Refresh modal
                });
            });

            // Close button
            document.getElementById('close-char-modal').addEventListener('click', () => {
                modal.style.display = 'none';
                renderUserList(); // Refresh table
            });

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    renderUserList();
                }
            });
        }

        function addCharacterToUser(userIndex, characterName) {
            const localUsers = getLocalUsers();
            if (!localUsers[userIndex].characters) {
                localUsers[userIndex].characters = [];
            }
            localUsers[userIndex].characters.push(characterName);
            saveLocalUsers(localUsers);
        }

        function removeCharacterFromUser(userIndex, charIndex) {
            const localUsers = getLocalUsers();
            if (localUsers[userIndex].characters) {
                localUsers[userIndex].characters.splice(charIndex, 1);
                saveLocalUsers(localUsers);
            }
        }

        function executeDeleteUser(index) {
            const localUsers = getLocalUsers();
            const user = localUsers[index];
            console.log('Deleting user:', user.username);
            localUsers.splice(index, 1);
            saveLocalUsers(localUsers);
            renderUserList();
        }

        function getLocalUsers() {
            const stored = localStorage.getItem('localUsers');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return [...users]; // Fallback to original
                }
            }
            return [...users]; // Copy of original users array
        }

        function saveLocalUsers(userList) {
            localStorage.setItem('localUsers', JSON.stringify(userList));
        }

        async function addNewUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            if (!username || !password) {
                alert('Please enter username and password.');
                return;
            }

            const localUsers = getLocalUsers();

            // Check if username already exists
            if (localUsers.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                alert('Username already exists.');
                return;
            }

            // Hash password
            const passwordHash = await hashPassword(password);

            localUsers.push({
                username: username,
                passwordHash: passwordHash,
                role: role
            });

            saveLocalUsers(localUsers);

            // Clear form
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-role').value = 'custom';

            renderUserList();
            alert('User added successfully!');
        }

        async function editUserPrompt(index) {
            const localUsers = getLocalUsers();
            const user = localUsers[index];

            const newUsername = prompt('Enter new username:', user.username);
            if (newUsername === null) return; // Cancelled

            const newRole = prompt('Enter role (admin or custom):', user.role);
            if (newRole === null) return;

            const changePassword = confirm('Do you want to change the password?');
            let newPasswordHash = user.passwordHash;

            if (changePassword) {
                const newPassword = prompt('Enter new password:');
                if (newPassword) {
                    newPasswordHash = await hashPassword(newPassword);
                }
            }

            localUsers[index] = {
                username: newUsername.trim() || user.username,
                passwordHash: newPasswordHash,
                role: (newRole === 'admin' || newRole === 'custom') ? newRole : user.role
            };

            saveLocalUsers(localUsers);
            renderUserList();
            alert('User updated successfully!');
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
    </script>
</body>

</html>